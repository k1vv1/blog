---
title: 微信小程序登录流程
date: 2023-12-16
tags: [微信小程序，登录]
---

## 一、前言

今天好好分析一下微信小程序的整个登录流程

<!-- more -->

## 二、流程

- 1、在小程序内我们通过 `wx.login` 接口获得 `code`
- 2、将 `code` 传入后台，后台通过 `code2session` 接口对微信服务器发起请求换取 `openid`、`session_key`
- 3、后台生成一个自身的 `3rd_session`,以此为 `key` 值保存 `openid` 和 `session_key`
- 4、小程序拿到 `3rd_session` 之后保存在本地
- 5、小程序请求登录接口，通过 `wx.checkSession` 检查登录态，如果失效重新走上述登录流程，否则带上 `3rd_session` 到后台进行登录验证

## 三、Q & A

**<font color=red>Q：可不可以不按微信提供的流程走？微信虽然强调为了自身应用安全，`session_key` 不应该在网络上传输，却没有说不可以传输 `openid`，如果将 `openid` 直接返回给前端小程序，会不会更加放便？`session_key` 有过期时间，必须适时重新获取，而针对每一个小程序，唯一标识用户的 `openid` 可不会过期，如果只在用户第一次登录的时候，通过后台请求到 openid，小程序缓存到本地，之后每次请求都以这个 `openid` 作为唯一凭证，岂不是一本万利？</font>**

**<font color=green>A：事实上，这样的做法忽略了一个致命的问题，手机上是可以切换微信账户的，如果手机 I 上原先登录了账户 A，已经保存了用户 A 得 `openid`，有一天手机 I 上切换到了账户 B，小程序检测到 `openid` 存在，并不会重新获取 `openid`，那么账户 B 就请求到了账户 A 的数据，这就造成数据混乱了。</font>**

**<font color=red>Q：要知道，手机切换了登录账号，登录态一定会过期，那么当用户每次进入小程序时我们可以通过 `wx.checkSession` 检测登录是否失效，如果失效重新获取 `openid` 不就行了？</font>**

**<font color=green>A：然而，以永不过期的 `openid` 作为登录凭证并不是明智之举，一旦被人截获，就十分危险了，而维护一个第三方的 `session`，至少拥有有效期，这在很大程度上增加了安全性。并且，现在不需要 `session_key`,不代表以后，保持系统的可扩展性，才能以不变应万变。</font>**
