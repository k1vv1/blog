---
title: 微信小程序运行机制
date: 2023-01-09
tags: [微信小程序]
---

## 一、微信小程序的运行流程

微信小程序从启动到最终被销毁，会经历很多不同的状态，小程序在不同状态下会有不同的表现形式。

<!-- more -->

### 1、微信小程序的启动模式

从广泛意义上来说，微信小程序的启动模式可以被分为两种状态，一种是冷启动，另一种为热启动，那么对于这两种启动模式的区别又是什么呢？

从系统的运行模式上，可以被区分为以下两种模式：

- 冷启动：如果用户是首次打开小程序，或者小程序被完全销毁后被用户再次打开，此时的小程序需要重新加载启动，就叫做冷启动。
- 热启动：如果用户已经打开过小程序了，然后在一定时间内再次打开该小程序，此时小程序并未被完全销毁，只是从后台状态进入前台状态，这个过程就是热启动。

从小程序的生命周期函数触发的角度来看，我们一般听说的启动，专指为冷启动，热启动一般被称为后台切换为前台。

### 2、前台与后台的概念

小程序启动后，界面被展示出来给用户呈现后，此时小程序处于「前台」状态。

当用户「关闭」小程序时，小程序其实并没有真正被关闭，而是进入了「后台」状态，此时小程序还可以短暂运行一小段时间，但部分 API 的使用会受到限制。切入后台的方式包括但不限于以下几种：

- 点击右上角胶囊按钮离开小程序
- ios 从屏幕左侧右滑离开小程序
- 安卓点击返回键离开小程序
- 小程序前台运行时直接把微信切后台（手势或 Home 键）
- 小程序前台运行时直接锁屏

以上几种的操作触发时，一定时间内，小程序均未完全被退出。当用户再次进入微信并打开小程序，小程序又回重新进入「前台」状态。

### 3、挂起

小程序进入「后台」状态一段时间后，微信会停止对小程序 JS 线程的执行，小程序则会进入「挂起」状态。而此时小程序的内存状态依然会被保留，但开发者代码的执行会停止，事件和接口回调会在小程序再次进入「前台」时触发。

### 4、微信小程序的销毁

当用户长时间未使用小程序时，或者系统资源紧张，小程序会被完全「销毁」，即完全终止运行。具体而言包括以下几种情形：

- 当小程序进入后台并被「挂起」后，如果很长时间都未再次进入前台，小程序会被销毁。
- 由于底层系统机制原因，当小程序占用系统资源过高，也可能会被系统销毁或被微信客户端主动回收。

## 二、微信小程序冷启动的页面

当微信小程序执行冷启动时，打开的页面有以下情况：

（A 类场景）若启动的场景中不带指定页面路径：

- `基础库 2.8.0` 以下版本，在冷启动时默认直接进入首页。
- `基础库 2.8.0` 及以上版本遵循「重新启动策略」，可能是首页或上次退出的页面。

（B 类场景）若启动的场景中带有指定页面路径，则启动会进入对应指定页面路径的页面。

### 1、从新启动策略

> 当小程序冷启动时，如果启动时不带 `path`（A 类场景），默认情况下会进入小程序的首页。在页面对应的 `json` 文件中（也可以全局配置在 `app.json` 的 `window` 段中），指定 `restartStrategy` 配置项可以改变这个默认的行为，使得从某个页面退出后，下次 A 类场景的冷启动可以回到这个页面。

```js
{
  "restartStrategy": "homePage"
}
```

**注意：**

即使不配置为 `homePage`, 微信小程序如果退出过久，下次冷启动时也将不再遵循 `restartStrategy` 的配置，而是直接从首页冷启动。

当完全退出时，页面中的状态并不会被保留，如输入框中的文本内容、`checkbox` 的勾选状态等都不会还原。如果需要还原或部分还原，需要利用退出状态。

## 三、微信小程序热启动页面

当微信小程序执行热启动时，打开的页面也有以下情况：

- （A 类场景）若启动的场景中不带指定页面路径，则保留上次的浏览状态
- （B 类场景）若启动的场景中带有指定页面路径，则会直接加载到对应路径的页面

A 类场景有以下一些能被触发的场景：

| 状态码 |                                                   描述                                                   |
| :----: | :------------------------------------------------------------------------------------------------------: |
|  1001  |            发现栏小程序主入口，「最近使用」列表（基础库 2.2.4 版本起包含「我的小程序」列表）             |
|  1003  |                                              星标小程序列表                                              |
|  1023  |                                         系统桌面小图标打开小程序                                         |
|  1038  |                                          从其他小程序返回小程序                                          |
|  1056  |                                 聊天顶部音乐播放器右上角菜单，打开小程序                                 |
|  1080  |                                    客服会话菜单小程序入口，打开小程序                                    |
|  1083  |                       公众号会话菜单小程序入口，打开小程序（只有腾讯客户小程序有）                       |
|  1089  | 聊天主界面下拉，打开小程序/微信聊天主界面下拉，「最近使用」栏（基础库 2.2.4 版本起包含「我的小程序」栏） |
|  1090  |                                     长按小程序右上角菜单，打开小程序                                     |
|  1103  |                                 发现-小程序主入口我的小程序，打开小程序                                  |
|  1104  |                                 聊天主界面下拉，从我的小程序，打开小程序                                 |
|  1113  |                                        安卓手机负一屏，打开小程序                                        |
|  1114  |                                        安卓手机侧边栏，打开小程序                                        |
|  1117  |                                   后台运行小程序的管理页中，打开小程序                                   |

## 四、退出状态

每当微信小程序可能被销毁之前，页面回调函数 `onSaveExitState` 会被触发。如果想保留页面总的状态，可以在这个回调函数中"保存"一些数据，下次启动时可以从新获得这些已保存的数据。

```js
{
  "restartStrategy": "homePageAndLatestPage"
}
```

```js
Page({
  onLoad() {
    var prevExitState = this.exitState; // 尝试获得上一次退出前 onSaveExitState 保存的数据
    if (prevExitState !== undefined) {
      // 如果是根据 restartStrategy 配置进行的冷启动，就可以获取到
      prevExitState.myDataField === "上一次保存的数据";
    }
  },
  onSaveExitState() {
    // 需要保存的数据
    let exitState = {
      myDataField: "上一次保存的数据",
    };
    return {
      data: exitState,
      expireTimeStamp: Date.now() + 24 * 60 * 60 * 1000, // 超时时刻
    };
  },
});
```

onSaveExitState 返回值可以包含两项：

|     字段名      |  类型  |                                    含义                                     |
| :-------------: | :----: | :-------------------------------------------------------------------------: |
|      data       |  Any   |                  需要保存的数据（只能是 JSON 兼容的数据）                   |
| expireTimeStamp | Number | 超时时刻，在这个时刻后，保存的数据保证一定被丢弃，默认为（当前时刻 + 1 天） |

**注意点补充**

- 如果超过 `expireTimeStamp` 所设置的时间范围，那么保存的数据将被丢弃，并且冷启动时不遵循 `restartStrategy` 的配置，而是直接从首页冷启动。
- `expireTimeStamp` 有可能被自动提前，如微信客户端需要清理数据的时候。
- 在小程序存活期间，`onSaveExitState` 可能会被多次调用，此时以最后一次的调用结果作为最终结果。
- 在某些特殊情况下（如微信客户端直接被系统杀死，或系统出现异常，强制性终止微信客户端运行环境），这个方法将不会被调用，下次冷启动也不遵循 `restartStrategy` 的配置，而是直接从首页冷启动。
